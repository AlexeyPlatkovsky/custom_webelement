buildscript {
  dependencies {
    classpath 'org.sonarsource.scanner.gradle:sonarqube-gradle-plugin:2.8'
  }
}

plugins {
  id 'io.franzbecker.gradle-lombok' version '4.0.0'
  id 'checkstyle'
  id 'maven'
  id 'java'
  id 'idea'
}

ext {
  archivesBaseName = 'autotests'
}

sourceCompatibility = 8.0
targetCompatibility = 8.0

idea {
  module {
    outputDir = file("${project.buildDir}/classes/java/main")
    testOutputDir = file("${project.buildDir}/classes/java/test")
  }
}

repositories {
  mavenCentral()
  mavenLocal()
}

dependencies {
  compile(
    [group: 'com.sun.mail', name: 'javax.mail', version: '1.6.2'],
    [group: 'io.github.bonigarcia', name: 'webdrivermanager', version: '4.0.0'],
    [group: 'org.seleniumhq.selenium', name: 'selenium-java', version: '3.141.59'],
    [group: 'org.seleniumhq.selenium', name: 'selenium-remote-driver', version: '3.141.59'],
    [group: 'org.testng', name: 'testng', version: '7.3.0'],
    [group: 'org.apache.logging.log4j', name: 'log4j-api', version: '2.13.3'],
    [group: 'org.apache.logging.log4j', name: 'log4j-core', version: '2.13.3'],
    [group: 'com.fasterxml.jackson.core', name: 'jackson-databind', version: '2.11.2'],
    [group: 'io.rest-assured', name: 'rest-assured', version: '4.3.1'],
    [group: 'org.hamcrest', name: 'hamcrest-all', version: '1.3'],
    [group: 'org.json', name: 'json', version: '20200518'],
    [group: 'org.springframework', name: 'spring-web', version: '5.3.1'],
    [group: 'com.jayway.jsonpath', name: 'json-path', version: '2.4.0'],
    [group: 'com.googlecode.json-simple', name: 'json-simple', version: '1.1.1'],
    [group: 'org.assertj', name: 'assertj-core', version: '3.11.1'],
    [group: 'org.apache.poi', name: 'poi-ooxml', version: '3.9'],
  )

  implementation(
    "com.google.guava:guava:29.0-jre"
  )
}

//=================================== Test =====================================

task runTests(type: Test) {
  def base_url = project.hasProperty('base_url') ? project.base_url : ''
  systemProperty 'base_url', base_url

  def browser = project.hasProperty('browser') ? project.browser : 'CHROME'
  systemProperty 'browser', browser

  def browser_version = project.hasProperty('browser_version') ? project.browser_version : 'latest'
  systemProperty 'browser_version', browser_version

  def build_number = project.hasProperty('build_number') ? project.build_number : new Date().format('MMddyyhhmmss')
  systemProperty 'build_number', build_number

  def driver = project.hasProperty('driver') ? project.driver : 'CHROME'
  systemProperty 'driver', driver

  def platform = project.hasProperty('platform') ? project.platform : 'Windows 10'
  systemProperty 'platform', platform

  def remote_key = project.hasProperty('remote_key') ? project.remote_key : ''
  systemProperty 'remote_key', remote_key

  def remote_option = project.hasProperty('remote_option') ? project.remote_option : 'lambdatest'
  systemProperty 'remote_option', remote_option

  def remote_username = project.hasProperty('remote_username') ? project.remote_username : ''
  systemProperty 'remote_username', remote_username

  def screen_resolution = project.hasProperty('screen_resolution') ? project.screen_resolution : '1920x1080'
  systemProperty 'screen_resolution', screen_resolution

  def sierra_api_url = project.hasProperty('sierra_api_url') ? project.base_url : ''
  systemProperty 'sierra_api_url', sierra_api_url

  def suite = project.hasProperty('suite') ? project.suite : 'sanity'
  systemProperty 'suite', suite

  def thread_count = project.hasProperty('thread_count') ? project.thread_count : 1

  def exclude = project.hasProperty('exclude') ? project.exclude : 'disabled'

  useTestNG() {
    testLogging.showStandardStreams = true
    useDefaultListeners = true
    outputDirectory = file("$projectDir/build/reports/tests/testng")
    includeGroups suite
    excludeGroups exclude
    parallel 'methods'
    threadCount = thread_count as int
  }
}
