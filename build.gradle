buildscript {
  dependencies {
    classpath 'org.sonarsource.scanner.gradle:sonarqube-gradle-plugin:2.8'
  }
}

plugins {
  id 'io.franzbecker.gradle-lombok' version '4.0.0'
  id 'checkstyle'
  id 'java'
  id 'idea'
}

ext {
  archivesBaseName = 'autotests'
}

idea {
  module {
    outputDir = file("${project.buildDir}/classes/java/main")
    testOutputDir = file("${project.buildDir}/classes/java/test")
  }
}

repositories {
  mavenCentral()
  mavenLocal()
}

dependencies {
  implementation(
          [group: 'com.sun.mail', name: 'javax.mail', version: '1.6.2'],
          [group: 'io.github.bonigarcia', name: 'webdrivermanager', version: '4.0.0'],
          [group: 'org.apache.logging.log4j', name: 'log4j-api', version: '2.13.3'],
          [group: 'org.apache.logging.log4j', name: 'log4j-core', version: '2.13.3'],
          [group: 'org.seleniumhq.selenium', name: 'selenium-java', version: '4.3.0'],
          [group: 'org.seleniumhq.selenium', name: 'selenium-remote-driver', version: '4.3.0'],
          [group: 'org.testng', name: 'testng', version: '7.3.0']
  )
  compileOnly 'org.projectlombok:lombok:1.18.24'
  annotationProcessor 'org.projectlombok:lombok:1.18.24'

  testCompileOnly 'org.projectlombok:lombok:1.18.24'
  testAnnotationProcessor 'org.projectlombok:lombok:1.18.24'
}

//=================================== Test =====================================

task runTests(type: Test) {
  def base_url = project.hasProperty('base_url') ? project.base_url : ''
  systemProperty 'base_url', base_url

  def browser = project.hasProperty('browser') ? project.browser : 'CHROME'
  systemProperty 'browser', browser

  def browser_version = project.hasProperty('browser_version') ? project.browser_version : 'latest'
  systemProperty 'browser_version', browser_version

  def build_number = project.hasProperty('build_number') ? project.build_number : new Date().format('MMddyyhhmmss')
  systemProperty 'build_number', build_number

  def driver = project.hasProperty('driver') ? project.driver : 'CHROME'
  systemProperty 'driver', driver

  def locale = project.hasProperty('locale') ? project.locale : 'en-US'
  systemProperty 'locale', locale

  def platform = project.hasProperty('platform') ? project.platform : 'Windows 10'
  systemProperty 'platform', platform

  def remote_key = project.hasProperty('remote_key') ? project.remote_key : ''
  systemProperty 'remote_key', remote_key

  def remote_username = project.hasProperty('remote_username') ? project.remote_username : ''
  systemProperty 'remote_username', remote_username

  def screen_resolution = project.hasProperty('screen_resolution') ? project.screen_resolution : '1920x1080'
  systemProperty 'screen_resolution', screen_resolution

  def suite = project.hasProperty('suite') ? project.suite : 'ui'
  systemProperty 'suite', suite

  def thread_count = project.hasProperty('thread_count') ? project.thread_count : 2

  def exclude = project.hasProperty('exclude') ? project.exclude : 'disabled'

  useTestNG() {
    testLogging.showStandardStreams = true
    useDefaultListeners = true
    outputDirectory = file("$projectDir/build/reports/tests/testng")
    includeGroups suite
    excludeGroups exclude
    parallel 'methods'
    threadCount = thread_count as int
  }
}
